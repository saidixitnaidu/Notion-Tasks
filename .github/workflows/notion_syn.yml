name: Notion Sync (secrets)

on:
  schedule:
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dateutil python-dotenv

      - name: Run Notion reminder script
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ASSIGNEE_MAP: ${{ secrets.ASSIGNEE_MAP }}
          TIMEZONE: ${{ secrets.TIMEZONE }}
          REMIND_MINUTES: ${{ secrets.REMIND_MINUTES }}
        run: |
          # optional debug (prints present keys only)
          python - <<'PY'
          import os, json
          keys = ["NOTION_TOKEN","NOTION_DB_ID","TELEGRAM_BOT_TOKEN","ASSIGNEE_MAP","TIMEZONE","REMIND_MINUTES"]
          loaded = [k for k in keys if os.environ.get(k)]
          print("[env] present:", loaded)
          # parse ASSIGNEE_MAP to ensure valid JSON
          try:
              json.loads(os.environ.get("ASSIGNEE_MAP","{}"))
              print("[env] ASSIGNEE_MAP valid JSON")
          except Exception as e:
              print("[env] ASSIGNEE_MAP JSON error:", e); raise SystemExit(2)
          PY

          # run your script (adjust path if needed)
          python Notion/notion_sync.py
